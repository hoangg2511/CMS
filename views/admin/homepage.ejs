<% const renderCtaButton = (button, index) => `
<div class="input-group mb-2 cta-item">
  <input
    type="text"
    class="form-control"
    name="heroSection.ctaButtons[${index}].text"
    placeholder="Button Text"
    value="${button.text || ''}"
    required
  />
  <input
    type="text"
    class="form-control"
    name="heroSection.ctaButtons[${index}].link"
    placeholder="Link (URL)"
    value="${button.link || ''}"
    required
  />
  <button type="button" class="btn btn-danger remove-item" data-type="cta">
    <i class="bi bi-trash"></i>
  </button>
</div>
`; const renderFeatureItem = (feature, index) => `
<div class="input-group mb-2 feature-item">
  <input
    type="text"
    class="form-control"
    name="whyChooseLAMSSection.features[${index}]"
    placeholder="Feature Content"
    value="${feature || ''}"
    required
  />
  <button type="button" class="btn btn-danger remove-item" data-type="feature">
    <i class="bi bi-trash"></i>
  </button>
</div>
`; const renderStatisticItem = (stat, index) => `
<div class="input-group mb-2 stat-item">
  <input
    type="text"
    class="form-control"
    name="accreditationSection.statistics[${index}].label"
    placeholder="Statistic Label"
    value="${stat.label || ''}"
    required
  />
  <input
    type="text"
    class="form-control"
    name="accreditationSection.statistics[${index}].value"
    placeholder="Value"
    value="${stat.value || ''}"
    required
  />
  <button type="button" class="btn btn-danger remove-item" data-type="stat">
    <i class="bi bi-trash"></i>
  </button>
</div>
`; %>
<div class="admin-homepage-management">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-house-door-fill"></i> Homepage Management</h2>
  </div>

  <% if (typeof successMessage !== 'undefined' && successMessage) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle"></i> <%= successMessage %>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="alert"
      aria-label="Close"
    ></button>
  </div>
  <% } %>

  <form id="homepageForm" onsubmit="updateHomePage()" novalidate>
    <div class="card border shadow-sm mb-4">
      <div class="card-body py-2 px-4">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <span
              class="text-muted fw-bold small text-uppercase me-3"
              style="letter-spacing: 0.5px"
            >
              Status:
            </span>
            <% if (typeof isDraft !== 'undefined' && isDraft) { %>
            <span class="badge bg-warning text-dark rounded-pill px-3">
              <i class="bi bi-pencil-square me-1"></i> Draft
            </span>
            <% } else { %>
            <span class="badge bg-success rounded-pill px-3">
              <i class="bi bi-check-circle-fill me-1"></i> Published
            </span>
            <% } %>
          </div>

          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-outline-info btn-sm px-4 rounded-pill shadow-sm"
              onclick="viewUpdate()"
              id="btnViewUpdate"
            >
              <i class="bi bi-eye-fill me-1"></i>
              View Update (Demo)
            </button>

            <button
              type="button"
              class="btn btn-primary btn-sm px-4 rounded-pill shadow-sm"
              onclick="submitPublish()"
              id="btnPublish"
            >
              <i class="bi bi-cloud-arrow-up-fill me-1"></i>
              Publish Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="hero-tab"
          data-bs-toggle="tab"
          data-bs-target="#hero"
          type="button"
          role="tab"
        >
          Hero & CTA
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="vmp-tab"
          data-bs-toggle="tab"
          data-bs-target="#vmp"
          type="button"
          role="tab"
        >
          VMP & Who We Are
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="choose-tab"
          data-bs-toggle="tab"
          data-bs-target="#choose"
          type="button"
          role="tab"
        >
          Advantages (Features)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="stats-tab"
          data-bs-toggle="tab"
          data-bs-target="#stats"
          type="button"
          role="tab"
        >
          Accreditation & Stats
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="news-tab"
          data-bs-toggle="tab"
          data-bs-target="#news"
          type="button"
          role="tab"
        >
          Featured News
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="seo-tab"
          data-bs-toggle="tab"
          data-bs-target="#seo"
          type="button"
          role="tab"
        >
          SEO
        </button>
      </li>
    </ul>

    <div
      class="tab-content border border-top-0 p-4 bg-white shadow-sm mb-5"
      id="myTabContent"
    >
      <div
        class="tab-pane fade show active"
        id="hero"
        role="tabpanel"
        aria-labelledby="hero-tab"
      >
        <h3>Hero Section Content</h3>
        <div class="form-group mb-3">
          <label for="heroSection.title" class="form-label">Main Title</label>
          <input
            type="text"
            class="form-control"
            name="heroSection.title"
            value="<%= homepage.heroSection.title || '' %>"
            required
          />
        </div>
        <div class="form-group mb-3">
          <label for="heroSection.subtitle" class="form-label">Subtitle</label>
          <input
            type="text"
            class="form-control"
            name="heroSection.subtitle"
            required
            value="<%= homepage.heroSection.subtitle || '' %>"
          />
        </div>
        <div class="form-group mb-3">
          <label class="form-label">Hero Background Image</label>

          <input
            type="file"
            id="singleHeroImageInput"
            accept="image/*"
            hidden
            onchange="uploadHomepageHeroImage()"
          />

          <input
            type="text"
            class="form-control mb-2"
            name="heroSection.backgroundImage"
            id="heroBackgroundImageInput"
            value="<%= homepage.heroSection.backgroundImage || '' %>"
            required
          />

          <button
            type="button"
            class="btn btn-outline-primary w-100 mb-2"
            onclick="document.getElementById('singleHeroImageInput').click()"
          >
            <i class="bi bi-upload"></i> Upload Ảnh Mới
          </button>

          <div class="mt-2">
            <label class="form-label small text-muted">Current image:</label>
            <img
              id="heroImagePreview"
              src="/uploads/<%= homepage.heroSection.backgroundImage || 'placeholder.jpg' %>"
              class="img-thumbnail"
              style="
                width: 80px;
                height: 60px;
                object-fit: cover;
                display: block;
              "
              alt="Hero Background Preview"
            />
          </div>
        </div>

        <h4 class="mt-4">CTA Buttons</h4>
        <div id="ctaButtonsContainer">
          <% homepage.heroSection.ctaButtons.forEach((button, index) => { %> <%-
          renderCtaButton(button, index) %> <% }) %>
        </div>
        <button
          type="button"
          class="btn btn-info btn-sm"
          onclick="addItem('cta')"
        >
          <i class="bi bi-plus-circle"></i> Add CTA Button
        </button>
      </div>

      <div
        class="tab-pane fade"
        id="vmp"
        role="tabpanel"
        aria-labelledby="vmp-tab"
      >
        <h3 class="mt-0">Who We Are Section</h3>
        <div class="form-group mb-4">
          <label for="whoWeAreSection.title" class="form-label">Title</label>
          <input
            type="text"
            class="form-control"
            name="whoWeAreSection.title"
            value="<%= homepage.whoWeAreSection.title %>"
            required
          />
        </div>
        <div class="form-group mb-4">
          <label for="whoWeAreSection.content" class="form-label"
            >Content</label
          >
          <textarea
            class="form-control"
            name="whoWeAreSection.content"
            rows="5"
            required
          >
<%= homepage.whoWeAreSection.content %></textarea
          >
        </div>

        <hr />

        <h3>Vision, Mission & Philosophy</h3>
        <% ['vision', 'mission', 'philosophy'].forEach(key => { %>
        <div class="card mb-3">
          <div class="card-header bg-light">
            <strong><%= key.charAt(0).toUpperCase() + key.slice(1) %></strong>
          </div>
          <div class="card-body">
            <div class="form-group mb-2">
              <label class="form-label">Title for <%= key %></label>
              <input
                type="text"
                class="form-control"
                name="visionMissionPhilosophySection.<%= key %>.title"
                value="<%= homepage.visionMissionPhilosophySection[key].title %>"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">Content for <%= key %></label>
              <textarea
                class="form-control"
                name="visionMissionPhilosophySection.<%= key %>.content"
                rows="3"
                required
              >
<%= homepage.visionMissionPhilosophySection[key].content %></textarea
              >
            </div>
          </div>
        </div>
        <% }) %>
      </div>

      <div
        class="tab-pane fade"
        id="choose"
        role="tabpanel"
        aria-labelledby="choose-tab"
      >
        <h3>Why Choose Us Section</h3>
        <div class="form-group mb-3">
          <label for="whyChooseLAMSSection.title" class="form-label"
            >Title</label
          >
          <input
            type="text"
            class="form-control"
            name="whyChooseLAMSSection.title"
            value="<%= homepage.whyChooseLAMSSection.title %>"
            required
          />
        </div>
        <div class="form-group mb-3">
          <label for="whyChooseLAMSSection.content" class="form-label"
            >Introduction Content</label
          >
          <textarea
            class="form-control"
            name="whyChooseLAMSSection.content"
            rows="3"
          >
<%= homepage.whyChooseLAMSSection.content || '' %></textarea
          >
        </div>
        <div class="form-group mb-3">
          <label class="form-label">Image Section</label>

          <input
            type="file"
            id="singleWhyChooseImageInput"
            accept="image/*"
            hidden
            onchange="uploadWhyChooseImage()"
          />

          <input
            type="text"
            class="form-control mb-2"
            name="whyChooseLAMSSection.image"
            id="whyChooseImageInput"
            value="<%= homepage.whyChooseLAMSSection.image || '' %>"
          />

          <button
            type="button"
            class="btn btn-outline-primary w-100 mb-2"
            onclick="document.getElementById('singleWhyChooseImageInput').click()"
          >
            <i class="bi bi-upload"></i> Upload Ảnh Mới
          </button>

          <div class="mt-2">
            <label class="form-label small text-muted">Current image:</label>
            <img
              id="whyChooseImagePreview"
              src="/uploads/<%= homepage.whyChooseLAMSSection.image || 'placeholder.jpg' %>"
              class="img-thumbnail"
              style="
                width: 80px;
                height: 60px;
                object-fit: cover;
                display: block;
              "
              alt="Why Choose LAMS Image Preview"
            />
          </div>
        </div>

        <h4 class="mt-4">Features (List of Strings)</h4>
        <div id="featuresContainer">
          <% homepage.whyChooseLAMSSection.features.forEach((feature, index) =>
          { %> <%- renderFeatureItem(feature, index) %> <% }) %>
        </div>
        <button
          type="button"
          class="btn btn-info btn-sm"
          onclick="addItem('feature')"
        >
          <i class="bi bi-plus-circle"></i> Add Feature
        </button>
      </div>

      <div
        class="tab-pane fade"
        id="stats"
        role="tabpanel"
        aria-labelledby="stats-tab"
      >
        <h3>Accreditation & Statistics</h3>
        <div class="form-group mb-3">
          <label for="accreditationSection.title" class="form-label"
            >Title</label
          >
          <input
            type="text"
            class="form-control"
            name="accreditationSection.title"
            value="<%= homepage.accreditationSection.title %>"
            required
          />
        </div>
        <div class="form-group mb-3">
          <label for="accreditationSection.content" class="form-label"
            >Introduction Content</label
          >
          <textarea
            class="form-control"
            name="accreditationSection.content"
            rows="3"
          >
<%= homepage.accreditationSection.content || '' %></textarea
          >
        </div>
        <div class="form-group mb-3">
          <label class="form-label"
            >Ảnh Chứng nhận/Kiểm định (Accreditation Image)</label
          >

          <input
            type="file"
            id="singleAccreditationImageInput"
            accept="image/*"
            hidden
            onchange="uploadAccreditationImage()"
          />

          <input
            type="text"
            class="form-control mb-2"
            name="accreditationSection.image"
            id="AccreditationImageInput"
            value="<%= homepage.accreditationSection.image || '' %>"
          />

          <button
            type="button"
            class="btn btn-outline-primary w-100 mb-2"
            onclick="document.getElementById('singleAccreditationImageInput').click()"
          >
            <i class="bi bi-upload"></i> Upload Ảnh Mới
          </button>

          <div class="mt-2">
            <label class="form-label small text-muted">Current image:</label>
            <img
              id="AccreditationImagePreview"
              src="/uploads/<%= homepage.accreditationSection.image || 'placeholder.jpg' %>"
              class="img-thumbnail"
              style="
                width: 80px;
                height: 60px;
                object-fit: cover;
                display: block;
              "
              alt="Accreditation Image Preview"
            />
          </div>
        </div>

        <h4 class="mt-4">Statistics</h4>
        <div id="statisticsContainer">
          <% homepage.accreditationSection.statistics.forEach((stat, index) => {
          %> <%- renderStatisticItem(stat, index) %> <% }) %>
        </div>
        <button
          type="button"
          class="btn btn-info btn-sm"
          onclick="addItem('stat')"
        >
          <i class="bi bi-plus-circle"></i> Add Statistic
        </button>
      </div>

      <div
        class="tab-pane fade"
        id="news"
        role="tabpanel"
        aria-labelledby="news-tab"
      >
        <h3>Featured News Section</h3>

        <div class="form-group mb-4">
          <label for="featuredNewsSection.title" class="form-label"
            >Section Title</label
          >
          <input
            type="text"
            class="form-control"
            name="featuredNewsSection.title"
            value="<%= homepage.featuredNewsSection.title %>"
            required
          />
        </div>

        <p class="text-info small">
          <i class="bi bi-lightbulb"></i> Select up to 3 News Events to feature.
        </p>

        <div class="list-group" id="featuredNewsContainer">
          <% homepage.featuredNewsSection.news.forEach((newsItem, index) => { %>
          <div
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center featured-news-item"
            data-id="<%= newsItem._id %>"
          >
            <%= newsItem.title || 'News Item ID: ' + newsItem._id %>

            <input
              type="hidden"
              name="featuredNewsSection.news[<%= index %>]"
              value="<%= newsItem._id %>"
            />

            <button
              type="button"
              class="btn btn-sm btn-danger remove-item"
              data-type="news"
            >
              <i class="bi bi-x"></i> Remove
            </button>
          </div>
          <% }) %>
        </div>

        <% if (homepage.featuredNewsSection.news.length < 3) { %>
        <button type="button" class="btn btn-primary mt-3">
          <i class="bi bi-plus"></i> Add News Event
        </button>
        <% } %>
        <p class="text-warning small mt-2">
          Current count: <%= homepage.featuredNewsSection.news.length %> / 3
        </p>
      </div>

      <div
        class="tab-pane fade"
        id="seo"
        role="tabpanel"
        aria-labelledby="seo-tab"
      >
        <h3>SEO Meta Tags</h3>
        <div class="form-group mb-3">
          <label for="seoMetaTag.metaTitle" class="form-label"
            >Meta Title</label
          >
          <input
            type="text"
            class="form-control"
            name="seoMetaTag.metaTitle"
            value="<%= homepage.seoMetaTag.metaTitle || '' %>"
          />
        </div>
        <div class="form-group mb-3">
          <label for="seoMetaTag.metaDescription" class="form-label"
            >Meta Description</label
          >
          <textarea
            class="form-control"
            name="seoMetaTag.metaDescription"
            rows="3"
          >
<%= homepage.seoMetaTag.metaDescription || '' %></textarea
          >
        </div>
        <div class="form-group mb-3">
          <label for="seoMetaTag.ogImage" class="form-label"
            >OG Image URL</label
          >
          <input
            type="text"
            class="form-control"
            name="seoMetaTag.ogImage"
            value="<%= homepage.seoMetaTag.ogImage || '' %>"
          />
        </div>
        <h4 class="mt-4">Meta Keywords (List of Strings)</h4>
        <div id="keywordsContainer">
          <% (homepage.seoMetaTag.metaKeywords || []).forEach(function (keyword,
          index) { %>
          <div class="input-group mb-2 keyword-item">
            <input
              type="text"
              class="form-control"
              name="seoMetaTag.metaKeywords[<%= index %>]"
              placeholder="Keyword"
              value="<%= keyword %>"
              required
            />
            <button
              type="button"
              class="btn btn-danger remove-item"
              data-type="keyword"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <% }); %>
        </div>

        <button
          type="button"
          class="btn btn-success btn-sm"
          onclick="addItem('keyword')"
        >
          <i class="bi bi-plus-circle"></i> Add Keyword
        </button>
      </div>
    </div>
    <div class="text-center mb-5">
      <button type="submit" class="btn btn-success btn-lg">
        <i class="bi bi-save"></i> Save & Update
      </button>
    </div>
  </form>
</div>

<script>
  function addItem(type) {
    let container, html, index;

    switch (type) {
      case "cta":
        container = document.getElementById("ctaButtonsContainer");
        index = container.querySelectorAll(".cta-item").length;
        html = `
                <div class="input-group mb-2 cta-item">
                    <input type="text" class="form-control" name="heroSection.ctaButtons[${index}].text" placeholder="Button Text" required>
                    <input type="text" class="form-control" name="heroSection.ctaButtons[${index}].link" placeholder="Link (URL)" required>
                    <button type="button" class="btn btn-danger remove-item" data-type="cta"><i class="bi bi-trash"></i></button>
                </div>`;
        break;

      case "feature":
        container = document.getElementById("featuresContainer");
        index = container.querySelectorAll(".feature-item").length;
        html = `
                <div class="input-group mb-2 feature-item">
                    <input type="text" class="form-control" name="whyChooseLAMSSection.features[${index}]" placeholder="Feature Content" required>
                    <button type="button" class="btn btn-danger remove-item" data-type="feature"><i class="bi bi-trash"></i></button>
                </div>`;
        break;

      case "stat":
        container = document.getElementById("statisticsContainer");
        index = container.querySelectorAll(".stat-item").length;
        html = `
                <div class="input-group mb-2 stat-item">
                    <input type="text" class="form-control" name="accreditationSection.statistics[${index}].label" placeholder="Statistic Label" required>
                    <input type="text" class="form-control" name="accreditationSection.statistics[${index}].value" placeholder="Value" required>
                    <button type="button" class="btn btn-danger remove-item" data-type="stat"><i class="bi bi-trash"></i></button>
                </div>`;
        break;

      case "keyword":
        container = document.getElementById("keywordsContainer");
        index = container.querySelectorAll(".keyword-item").length;
        html = `
                <div class="input-group mb-2 keyword-item">
                    <input type="text" class="form-control" name="seoMetaTag.metaKeywords[${index}]" placeholder="Keyword" required>
                    <button type="button" class="btn btn-danger remove-item" data-type="keyword"><i class="bi bi-trash"></i></button>
                </div>`;
        break;
    }

    if (html) {
      container.insertAdjacentHTML("beforeend", html);
    }
  }

  document.addEventListener("click", function (e) {
    const btn = e.target.closest("[data-type]");
    if (!btn || !btn.classList.contains("remove-item")) return;

    const wrapper = btn.closest(".input-group");
    if (!wrapper) return;

    wrapper.remove();
  });
</script>
